{% extends 'base.html' %}

{% load i18n %}

{% block title %}
    {% trans 'Компания' %}
{% endblock %}

{% block page_content %}
    <section class="account-page">
		<div class="container-fluid p-0">
			<div class="row wrapper m-auto">
				<div class="col-12 col-md-9 main-left-col">
					<div class="rating-table__heading">
						<h4 class="text-16px-white">{% trans 'Название компании / Карточка' %}</h4>
					</div>
				</div>

				<div class="col-12 col-md-3 main-right-col">
					<a id="" class="red-btn bid-btn" href="{% url 'create_trade' %}">{% trans 'Объявить новые торги' %}</a>
				</div>

				<div class="col-12 col-md-9 main-left-col ">
                    <div class="notation-box page-background-white">
                        <ul class="nav nav-tabs pills-navigation">
                          <li class="active"><a class="link-16px-2e2e2e active" data-toggle="tab" href="#card">{% trans 'Карточка' %}</a></li>
                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#users">{% trans 'Пользователи' %}</a></li>
                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#messages">{% trans 'Сообщения' %}</a></li>
{#                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#mailing">{% trans 'Рассылки' %}</a></li>#}
{#                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#product">{% trans 'Товар' %}</a></li>#}
                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#balance">{% trans 'Баланс' %}</a></li>
                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#bills">{% trans 'Счета' %}</a></li>
                          <li><a class="link-16px-2e2e2e" data-toggle="tab" href="#menu2">{% trans 'Связанные компании' %}</a></li>
                          <li>  <a class="link-16px-2e2e2e" data-toggle="tab" href="#trades">{% trans 'Мои торги' %}</a>
                          </li>
                        </ul>
                    </div>

                    <div class="tab-content account-page__content page-background-white">
                        <!-- Вкладка Карточка начало-->
                        <div id="card" class="tab-pane fade in active show">
                            <div class="notation-box">
                                <h4 id="company-name"></h4>
                            </div>

                            <div class="trade-table__heading justify-content-center">
                                <h4 class="text-16px-white">{% trans 'Информация о компании' %}</h4>
                            </div>

                            <div class="account-page__card">
                                <div class="account-page__card-info">
                                    <div class="list-wrap">
                                        <div class="list-item">
                                            <span class="list-item-heading text-12px-black">{% trans 'Генеральный директор' %}</span>
                                            <span id="director" class="list-item-value text-12px-585858"></span>
                                        </div>

                                        <div class="list-item">
                                            <span class="list-item-heading text-12px-black">{% trans 'Тип компании' %}</span>
                                            <span id="account-type" class="list-item-value text-12px-585858"></span>
                                        </div>

                                        <div class="list-item">
                                            <span class="list-item-heading text-12px-black">{% trans 'ИНН' %}</span>
                                            <span id="company-id" class="list-item-value text-12px-585858"></span>
                                        </div>

{#                                        <div class="list-item">#}
{#                                            <span class="list-item-heading text-12px-black">ОГРН</span>#}
{#                                            <span class="list-item-value text-12px-585858">85858585</span>#}
{#                                        </div>#}

                                        <div class="list-item">
                                            <span class="list-item-heading text-12px-black">{% trans 'Контакты' %}</span>
                                            <span class="list-item-value text-12px-585858">
                                                <ul>
                                                    <li>
                                                        <a id="phone" class="text-12px-585858" href="tel:+380000000000000">
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a id="phone-1" class="text-12px-585858" href="tel:+380000000000000">
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a id="phone-2" class="text-12px-585858" href="tel:+380000000000000">
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a id="email" class="text-12px-585858" href="mailto:testmail@gmail.com">
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a id="site" class="text-12px-585858" href="https://google.com"></a>
                                                    </li>
                                                </ul>
                                            </span>
                                        </div>

                                        <div class="list-item">
                                            <span class="list-item-heading text-12px-black">
                                                {% trans 'Информация для контрагентов' %}
                                            </span>
                                            <span id="info" class="list-item-value text-12px-585858"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="account-page__address">
                                    <h5 class="list-item-heading text-center">{% trans 'Адрес компнии' %}</h5>
                                    <p id="address" class="list-item-heading text-12px-585858"></p>
                                </div>
                            </div>

                            <a href="{% url 'account_edit' user.account.id %}" class="red-btn account-redact">
                                {% trans 'Редактировать' %}
                            </a>
                        </div>
                        <!-- Вкладка Карточка конец-->

                        <!-- Вкладка Пользователи начало-->
                        <div id="users" class="tab-pane account-users fade">
                            <div class="trade-table__wrap">
                                <div class="trade-table__heading justify-content-center">
                                    <h4 class="text-16px-white">{% trans 'Пользователи' %}</h4>
                                </div>

                                <div class="table-responsive">
                                    <table class="trade-table">
                                        <thead>
                                            <tr>
                                                <th scope="col">
                                                    <span class="text-11px-334150 trade-table__heading-endtime">
                                                        {% trans 'ФИО / Должность' %}
                                                    </span>
                                                </th>
                                                <th scope="col">
                                                    <span class="text-11px-334150 trade-table__heading-weight">
                                                        {% trans 'Контакты' %}
                                                    </span>
                                                </th>
                                                <th scope="col">
                                                    <span class="text-11px-334150 trade-table__heading-product">
                                                        {% trans 'Активность' %}
                                                    </span>
                                                </th>
                                                <th scope="col">
                                                    <span class="text-11px-334150 trade-table__heading-product">
                                                        {% trans 'Действие' %}
                                                    </span>
                                                </th>
                                            </tr>
                                        </thead>

                                        <tbody></tbody>

                                    </table>
                                </div>
                                <a href="#account-add-user" onclick="showAddUserButton()" id="account__add-user" class="red-btn registration-link">
                                    {% trans 'Добавить пользователя' %}
                                </a>
                            </div>

                        </div>
                        <!-- Вкладка Пользователи конец-->

                        <!-- Вкладка Сообщения начало-->
                        <div id="messages" class="tab-pane fade">
                            <div class="trade-table__heading justify-content-center">
                                <h4 class="text-16px-white">{% trans 'Сообщения' %}</h4>
                            </div>

                            <div id="account-messages-table-wrap" class="table-responsive lots-table-wrap">
                                <table id="account-messages" class="table"></table>
                                <div id="account-messages-gridpager"></div>
                            </div>

                            <div id="account-messages-table-paginator" class="my-table-paginator">

                                <ul class="pagination-box">
                                    <li class="pagination-item first">
                                        <a id="first_account-messages-gridpager" href="#">первая...</a>
                                    </li>

                                    <li class="pagination-item prev">
                                        <a id="prev_account-messages-gridpager" href="#">1</a>
                                    </li>

                                    <li class="pagination-item active">
                                        <a id="paginator_current_page" href="#">1</a>
                                    </li>

                                    <li class="pagination-item next">
                                        <a id="next_account-messages-gridpager" href="#">3</a>
                                    </li>

                                    <li class="pagination-item last">
                                        <a id="last_account-messages-gridpager" href="#">..последняя</a>
                                    </li>
                                </ul>

                            </div>

                        </div>
                        <!-- Вкладка Сообщения конец-->

                        <!-- Вкладка Торги начало-->
                        <div id="trades" class="tab-pane fade">
                            <div class="trade-table__heading justify-content-center">
                                <h4 class="text-16px-white">Торги</h4>
                            </div>

                            <div id="account-trades-table-wrap" class="table-responsive lots-table-wrap">
                                <table id="account-trades" class="table"></table>
                                <div id="account-trades-gridpager"></div>
                            </div>

                            <div id="account-trades-table-paginator" class="my-table-paginator">
                                <ul class="pagination-box">
                                <li class="pagination-item first">
                                    <a id="first_account-trades-gridpager" href="#">первая...</a>
                                </li>
                                <li class="pagination-item prev">
                                    <a id="prev_account-trades-gridpager" href="#">1</a>
                                </li>
                                <li class="pagination-item active">
                                    <a id="paginator_current_page" href="#">1</a>
                                </li>
                                <li class="pagination-item next">
                                    <a id="next_account-trades-gridpager" href="#">3</a>
                                </li>
                                <li class="pagination-item last">
                                    <a id="last_account-tradesgridpager" href="#">..последняя</a>
                                </li>
                                </ul>
                            </div>
                        </div>

                    </div>

                </div>

            </div>

        </div>

    </section>

<!-- Модальное окно "Добавить пользователя" начало -->
<div class="modal-wrap" id="account-add-user">
	<div class="close-button">
		<span>
			<svg id="close" class="svg-inline--fa fa-times-circle fa-w-16" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times-circle" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"></path></svg><!-- <i class="fas fa-times-circle"></i> -->
		</span>
	</div>
    <div class="modal__login-wrap">
        <div class="trade-table__heading">
            <h4 id="title" class="text-16px-white">{% trans 'Добавить пользователя' %}</h4>
        </div>

        <div class="modal-inner">
            <span id="description" class="text-12px-585858 text-300">
                {% trans 'Что бы добавить нового пользователя заполните форму' %}
            </span>

            <form id="account-add-user-form" action="">
                <div class="form-items-group">
                    <label class="control-label text-12px-585858"  for="">Фамилия</label>
                    <input id="last-name" class="form-item-square" type="text" placeholder="Фамилия" required>
                </div>

                <div class="form-items-group">
                    <label class="control-label text-12px-585858"  for="">Имя</label>
                    <input id="first-name" class="form-item-square" type="text" placeholder="Имя" required>
                </div>

                <div class="form-items-group">
                    <label class="control-label text-12px-585858"  for="">Отчество</label>
                    <input id="father-name" class="form-item-square" type="text" placeholder="Отчество" required>
                </div>

                <div class="form-items-group">
                    <label class="control-label text-12px-585858"  for="">Должность</label>
                    <input id="position" class="form-item-square" type="text" placeholder="Должность" required>
                </div>

                <div class="form-items-group">
			        <label class="control-label text-12px-585858" for="">Телефон</label>
			        <input id="user-phone" class="form-item-square tel-mask" type="phone" placeholder="+38(999) 999-99-99">
		        </div>

                <div class="form-items-group">
				    <label class="control-label required text-12px-585858" for="">Email</label>
				    <input id="user-email" class="form-item-square" type="email" required>
			    </div>
{##}
{#			    <div class="rext-response-box">#}
{#	         	    <span class="text-danger">#}
{#                        Компания по такому E-mail уже зарегистрирована, Вы можете воспользоваться#}
{#                        <a href="#">Восстановлением пароля</a>#}
{#                    </span>#}
{#	            </div>#}
{##}
{#	            <div class="form-items-group password-input">#}
{#	                <label class="control-label text-12px-585858" for="">Текущий пароль</label>#}
{#	                <input class="form-item-square" type="password" placeholder="Пароль" required>#}
{#	                <div class="show-password"></div>#}
{#	            </div>#}
{##}
	            <div class="form-items-group password-input">
	                <label class="control-label text-12px-585858" for="">{% trans 'Новый пароль' %}</label>
	                <input id="password" class="form-item-square" type="password" placeholder="Пароль" required>
                    <div class="show-password"></div>
	            </div>

                <div class="form-items-group button-group">
			        <a id="add-user" href="#" onclick="addUser()" class="red-btn registration-link">{% trans 'Сохранить' %}</a>
			        <a id="change-user" href="#" onclick="updateUser()" class="red-btn registration-link">{% trans 'Сохранить' %}</a>
			        <a href="#" onclick="$('#close').trigger('click');" class="red-btn btn-close">{% trans 'Отмена' %}</a>
		        </div>

            </form>

        </div>

    </div>

</div>
<!-- Модальное окно "Добавить пользователя" конец -->

{% endblock %}

{% block javascript %}
    <script>
        let userID

        function localReload() {
            $('[href="#users"]').trigger('click');
            $('#close').trigger('click');
        }

        function showAddUserButton() {
            $('#title').text("{% trans 'Добавить пользователя' %}")
            $('#description').text("{% trans 'Что бы добавить нового пользователя заполните форму' %}")

            $('#add-user').show()
            $('#change-user').hide()
        }

        function showChangeUserButton() {
            $('#title').text("{% trans 'Редактировать пользователя' %}")
            $('#description').text("{% trans 'Вы можете изменить данные этого пользователя' %}")

            $('#add-user').hide()
            $('#change-user').show()
        }

        function addUser() {

            $.ajax({
                type: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                url: "{% url 'user_create' %}",
                dataType: 'json',
                data:
                    {
                        first_name: $('#first-name').val(),
                        last_name: $('#last-name').val(),
                        father_name : $('#father-name').val(),
                        position : $('#position').val(),
                        email : $('#user-email').val(),
                        phone : $('#user-phone').val(),
                        password : $('#password').val(),
                    },
                success: function() {
                    localReload();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("ERROR: " + textStatus + ", " + errorThrown);
                    console.log(jqXHR);
                    alert(jqXHR.responseText);
                    //alert(jqXHR.responseJSON.email);
                }
            });
        }

        function updateUser() {
            $.ajax({
                type: 'PUT',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                url: "{% url 'user_edit' 123 %}".replace('123', userID),
                dataType: 'json',
                data:
                    {
                        first_name: $('#first-name').val(),
                        last_name: $('#last-name').val(),
                        father_name : $('#father-name').val(),
                        position : $('#position').val(),
                        email : $('#user-email').val(),
                        phone : $('#user-phone').val(),
                        password : $('#password').val(),
                    },
                success: function(data) {
                    localReload();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("ERROR: " + textStatus + ", " + errorThrown);
                    console.log(jqXHR);
                    alert(jqXHR.responseText);
                }
            });
        }

        function viewUser(id) {

            $.getJSON("{% url 'user_edit' 123 %}".replace('123', id), function (data) {
                $('#last-name').val(data.last_name)
                $('#first-name').val(data.first_name)
                $('#father-name').val(data.father_name)
                $('#position').val(data.position)
                $('#user-phone').val(data.phone)
                $('#user-email').val(data.email)
                $('#password').val(data.password)

                $('#account__add-user').trigger('click')

                userID = id
                showChangeUserButton()
            })
        }

        function deleteUser(id) {

            if (confirm("{% trans 'Вы уверены что хотите удалить данного пользователя' %}")) {

                $.ajax({
                    type: 'DELETE',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    url: "{% url 'user_edit' 123 %}".replace('123', id),
                    success: function() {
                        $('[href="#users"]').trigger('click');
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log("ERROR: " + textStatus + ", " + errorThrown);
                        console.log(jqXHR);
                        alert(jqXHR.responseText);
                    }
                });
            }
        }

        $(function () {
            //Card tab
            $("a[href='#card']").click(function () {
                $.getJSON("{% url 'account_card' user.account.id %}", function (data) {
                    $('#company-name').text(data.company)
                    $('#director').text(data.director)
                    $('#account-type').text(data.account_type)
                    $('#company-id').text(data.company_id)
                    $('#phone').text(data.phone)
                    $('#phone-1').text(data.phone_1)
                    $('#phone-2').text(data.phone_2)
                    $('#email').text(data.email)
                    $('#site').text(data.site)
                    $('#info').text(data.info)
                    $('#address').text(data.address)
                })
            })
            //Users tab
            $("a[href='#users']").click(function () {
                let users
                $.getJSON("{% url 'user_list' %}", function (data) {

                    $('#users tbody').empty()

                    $.each(data, function(key, value)
                    {
                        users +=
                            "<tr>" +
                                "<td scope='row'>" +
                                    "<a class='text-12px-585858' href='#' onclick='viewUser(" + value.id + ")'>" +
                                        value.first_name + ' ' + value.last_name + ' / ' + value.position +
                                    "</a>" +
                                "</td>" +

                                "<td>" +
                                    "<a class='text-12px-585858' href='tel:" + value.phone + "'>" +
                                        value.phone + ' / ' +
                                    "</a>" +
                                    "<a class='text-12px-585858' href='mailto:" + value.email + "'>" +
                                        value.email +
                                    "</a>" +
                                "</td>" +

                                "<td>" +
                                    "<span class='trade-table__product-name text-12px-585858'>" +
                                        value.last_login +
                                    "</span>" +
                                "</td>" +

                                "<td>" +
                                    "<div class='lost-wrap'>" +
                                        "<div class='lost-item'>" +
                                            "<a href='#' onclick='deleteUser(" + value.id + ")' class='red-btn table-button'> \
                                                {% trans 'Удалить' %} \
                                            </a>" +
                                        "</div>" +
                                    "</div>" +
                                "</td>" +
                            "</tr>";
                    })
                    $('#users tbody').append(users);
                })
            })
            //Messages tab
            $("a[href='#messages']").click(function () {
                $("#account-messages").jqGrid({
                    colModel: [
                        { name: 'id', label: "ID", width: 100, searchOnEnter: true},
                        { name: 'message_from', label: "От",  width: 150},
                        { name: 'subject', label: "Тема",  width: 150},
                        { name: 'text', label: "Сообщение",  width: 150},
                        { name: 'created', label: "Создано",  width: 150},
                    ],
                    guiStyle: 'bootstrap4',
                    autowidth: true,
                    // iconSet: 'fontAwesome',
                    iconSet: 'jQueryUI',
                    idPrefix: 'lot_',
                    caption: 'Сообщения',
                    pagermode: "simple",
                    pageable: true,
                    pager : '#account-messages-gridpager',
                    rowNum: '10',
                    viewrecords: true,
                    ignoreCase: false,
                    headertitles: true,
                    // multiSort: true,
                    // height: '100%',
                    //deepempty: true,
                    url: "{% url 'message_list' %}",
                    datatype: 'json',
                    loadonce: false,
                }).jqGrid('filterToolbar', {
                    // searchOnEnter: false,
                    Find: "Search",
                    autosearch: true,
                    searchOperators: true

                })
            })
            //Trades tab
            $("a[href='#trades']").click(function () {
                $("#account-trades").jqGrid({
                    colModel: [
                        { name: 'id', label: 'ID', searchOnEnter: true},
                        { name: 'trading_type', editable: true, label: "{% trans 'Вид заявки' %}"},
                        { name: 'trading_start', editable: true, label: "{% trans 'Начало торгов' %}"},
                        { name: 'trading_end', width: 200, editable: true, label: "{% trans 'Завершение торгов' %}"},
                        { name: 'trading_manager', editable: true, label: "{% trans 'Контактное лицо' %}"},
                        { name: 'shipment_country', editable: true, label: "{% trans 'Страна' %}"},
                        { name: 'shipment_country', editable: true, label: "{% trans 'Страна' %}"},
                        { name: 'shipment_country', editable: true, label: "{% trans 'Страна' %}"},
                        { name: 'shipment_country', editable: true, label: "{% trans 'Страна' %}"},
                        { name: 'shipment_country', editable: true, label: "{% trans 'Страна' %}"},
                        { name: 'shipment_region', editable: true, label: "{% trans 'Область' %}"},
                    ],
                    guiStyle: 'bootstrap4',
                    viewrecords: true,
                    altRows: true,
                    rowEdit: true,
                    pager : '#account-messages-gridpager',
                    url: "{% url 'trade_list' %}",
                    {#editurl: "{% url 'trade_list_create' %}",#}
                    datatype: 'json',
                    loadonce: false,

                    ondblClickRow: function (rowid) {
                        $('#account-trades').jqGrid('editGridRow', rowid,
                        {
                            left: 600,
                            width: 450,
                            closeAfterEdit: true,
                            recreateForm: true,
                        })
                    },
                }).jqGrid('filterToolbar', {
                    // searchOnEnter: false,
                    Find: 'Search',
                    autosearch: true,
                    searchOperators: true
                })
            })
        })

        $( document ).ready(function() {
            $("a[href='#card']").trigger('click');
        });
    </script>
{% endblock %}
